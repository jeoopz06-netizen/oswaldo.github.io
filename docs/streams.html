<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>La Papu Vista</title>
  <style>
    body { background:#181818; color:#fff; font-family:Arial,sans-serif; margin:0; }
    header { background:#202020; padding:15px; text-align:center; font-size:1.5em; font-weight:bold; }
    .container { display:flex; padding:20px; gap:20px; }
    .player { flex:3; }
    video { width:100%; border-radius:8px; background:#000; }
    .sidebar { flex:1; display:flex; flex-direction:column; gap:10px; max-height:80vh; overflow:auto; }
    .video-item { background:#202020; padding:10px; border-radius:6px; cursor:pointer; display:flex; gap:10px; align-items:center; }
    .video-item img { width:120px; height:70px; object-fit:cover; border-radius:4px; }
    .video-item:hover { background:#333; }
    .empty { opacity:0.7; font-size:0.95rem; }
  </style>

  <script src="//cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Incluye la librer√≠a EXACTAMENTE as√≠ y solo una vez -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script defer>
window.addEventListener('DOMContentLoaded', async () => {
  const supabaseUrl = "https://xsmxwjpgjfipxkgocitc.supabase.co";
  const supabaseKey = "TU_ANON_KEY_AQUI";
  const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

  const BUCKET = "videos";
  const ALLOWED_EXT = ["mp4", "webm", "ogg", "mov", "m4v", "mkv", "avi"]; // agrega lo que uses
  const isVideo = (name) => {
    const ext = name.split('.').pop()?.toLowerCase();
    return ALLOWED_EXT.includes(ext || "");
  };

  const lista = document.getElementById("videoList");
  const player = document.getElementById("videoPlayer");

  async function listOnce(prefix = "") {
    const { data, error } = await sb.storage.from(BUCKET).list(prefix, {
      limit: 100,
      sortBy: { column: "name", order: "asc" }
    });
    if (error) {
      console.error("Error list('" + prefix + "'):", error);
      return { files: [], folders: [] };
    }
    // En Supabase Storage, los elementos con 'id' y 'metadata' suelen ser archivos.
    // Las carpetas aparecen como items con 'id' undefined y a veces con type 'folder'.
    const files = [];
    const folders = [];
    (data || []).forEach(item => {
      if (!item?.name) return;
      // Heur√≠stica: si tiene 'id' o 'metadata' con eTag, lo tomamos como archivo.
      const looksLikeFile = !!item.id || !!item.metadata?.eTag || item.name.includes('.');
      if (looksLikeFile) {
        files.push({ name: item.name, fullPath: prefix ? `${prefix.replace(/\/?$/, "/")}${item.name}` : item.name });
      } else {
        folders.push({ name: item.name, fullPath: prefix ? `${prefix.replace(/\/?$/, "/")}${item.name}` : item.name });
      }
    });
    return { files, folders };
  }

  async function listarRecursivo(maxDepth = 2) {
    const encontrados = [];
    async function walk(prefix = "", depth = 0) {
      const { files, folders } = await listOnce(prefix);
      files.forEach(f => { if (isVideo(f.name)) encontrados.push(f.fullPath); });
      if (depth < maxDepth) {
        for (const folder of folders) {
          // Aseg√∫rate que la carpeta termine en '/'
          await walk(`${folder.fullPath}/`, depth + 1);
        }
      }
    }
    await walk("", 0);
    return encontrados;
  }

  function renderLista(paths) {
    lista.innerHTML = "";
    if (paths.length === 0) {
      lista.innerHTML = '<div class="empty">No se encontraron videos en este bucket/prefix.</div>';
      player.removeAttribute("src"); player.load();
      return;
    }
    paths.forEach(p => {
      const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(p);
      const publicUrl = pub.publicUrl;
      const label = p.split('/').pop();
      const thumbText = encodeURIComponent((label?.length > 18 ? label.slice(0,18) + "..." : label) || "video");
      const item = document.createElement("div");
      item.className = "video-item";
      item.innerHTML = `
        <img src="https://via.placeholder.com/120x70.png?text=${thumbText}" alt="thumb">
        <span title="${p}">${p}</span>
      `;
      item.onclick = () => cambiarVideo(p);
      lista.appendChild(item);
    });
    // Reproduce el primero
    cambiarVideo(paths[0]);
  }

  function cambiarVideo(path) {
    const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
    const url = pub.publicUrl;
    player.pause();
    player.src = url;
    player.load();
    console.log("‚ñ∂Ô∏è Reproduciendo:", path, "‚Üí", url);
  }

  // --- Diagn√≥stico extra: imprime qu√© bucket y URL se usan
  console.log("Proyecto:", supabaseUrl, "Bucket:", BUCKET);

  const paths = await listarRecursivo(3); // ajusta profundidad seg√∫n tus carpetas
  console.log("Videos encontrados:", paths);
  renderLista(paths);
});
</script>

</head>
<body>
  <header>
    <h1>üì∫ La Papu Vista</h1>
  </header>

  <div class="container">
    <div class="player">
      <video id="videoPlayer" controls preload="metadata">Tu navegador no soporta video.</video>
    </div>
    <div class="sidebar" id="videoList"></div>
  </div>
</body>

</html>
