<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>La Papu Vista</title>
  <style>
    body { background:#121212; color:#fff; font-family:Arial,sans-serif; margin:0; }
    header { background:#1f1f1f; padding:15px; text-align:center; font-size:1.8em; font-weight:bold; color:#ff5252; }
    .container { display:flex; padding:20px; gap:20px; }
    .player { flex:3; }
    video { width:100%; border-radius:10px; background:#000; box-shadow:0 0 15px rgba(0,0,0,0.6); }
    .sidebar { flex:1; display:flex; flex-direction:column; gap:15px; max-height:80vh; overflow:auto; }
    .video-item { background:#1f1f1f; padding:8px; border-radius:8px; cursor:pointer; transition:transform 0.2s, background 0.2s; }
    .video-item:hover { background:#2a2a2a; transform:scale(1.03); }
    .video-thumb { width:100%; border-radius:6px; object-fit:cover; }
    .empty { opacity:0.7; font-size:0.95rem; text-align:center; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer>
  window.addEventListener('DOMContentLoaded', async () => {
    const supabaseUrl = "https://xsmxwjpgjfipxkgocitc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzbXh3anBnamZpcHhrZ29jaXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjAwMjUsImV4cCI6MjA4NjgzNjAyNX0.KTWje5RPDXGChabHjeIEYwgygX_z58p0FpBmdA6cWD4";
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    const BUCKET = "videos";
    const ALLOWED_EXT = ["mp4","webm","ogg","mov","m4v","mkv","avi"];
    const isVideo = (name) => ALLOWED_EXT.includes(name.split('.').pop()?.toLowerCase() || "");

    const lista = document.getElementById("videoList");
    const player = document.getElementById("videoPlayer");

    async function listOnce(prefix = "") {
      const { data, error } = await sb.storage.from(BUCKET).list(prefix, { limit:100, sortBy:{ column:"name", order:"asc"} });
      if (error) { console.error(error); return { files:[], folders:[] }; }
      const files=[], folders=[];
      (data||[]).forEach(item=>{
        if (!item?.name) return;
        const looksLikeFile = !!item.id || !!item.metadata?.eTag || item.name.includes('.');
        if (looksLikeFile) files.push({ name:item.name, fullPath: prefix?`${prefix.replace(/\/?$/,"/")}${item.name}`:item.name });
        else folders.push({ name:item.name, fullPath: prefix?`${prefix.replace(/\/?$/,"/")}${item.name}`:item.name });
      });
      return { files, folders };
    }

    async function listarRecursivo(maxDepth=2) {
      const encontrados=[];
      async function walk(prefix="", depth=0) {
        const { files, folders } = await listOnce(prefix);
        files.forEach(f=>{ if(isVideo(f.name)) encontrados.push(f.fullPath); });
        if (depth<maxDepth) {
          for(const folder of folders) await walk(`${folder.fullPath}/`, depth+1);
        }
      }
      await walk("",0);
      return encontrados;
    }

    function renderLista(paths) {
      lista.innerHTML="";
      if(paths.length===0){
        lista.innerHTML='<div class="empty">No se encontraron videos.</div>';
        player.removeAttribute("src"); player.load();
        return;
      }
      paths.forEach(p=>{
        const { data:pub } = sb.storage.from(BUCKET).getPublicUrl(p);
        const url = pub.publicUrl;
        const item=document.createElement("div");
        item.className="video-item";
        // Usamos un <video> peque√±o como thumbnail
        item.innerHTML=`
          <video class="video-thumb" src="${url}" muted preload="metadata"></video>
        `;
        item.onclick=()=>cambiarVideo(p);
        lista.appendChild(item);
      });
      cambiarVideo(paths[0]);
    }

    function cambiarVideo(path){
      const { data:pub } = sb.storage.from(BUCKET).getPublicUrl(path);
      const url=pub.publicUrl;
      player.pause();
      player.src=url;
      player.load();
      console.log("‚ñ∂Ô∏è Reproduciendo:", path, "‚Üí", url);
    }

    const paths=await listarRecursivo(3);
    renderLista(paths);
  });
  </script>
</head>
<body>
  <header>üì∫ La Papu Vista</header>
  <div class="container">
    <div class="player">
      <video id="videoPlayer" controls preload="metadata">Tu navegador no soporta video.</video>
    </div>
    <div class="sidebar" id="videoList"></div>
  </div>
</body>
</html>
