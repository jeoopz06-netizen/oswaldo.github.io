<script type="module">
import { Viewer } from "@photo-sphere-viewer/core";

const RENDER_API_URL = "https://oswaldo-github-io-1.onrender.com";
const MP_PUBLIC_KEY = "TEST-4bbbd92f-1ea7-4b95-85a9-9e3fa6a3555c";

const SCENES = [
  { id: "lobby", name: "Lobby", url: "https://photo-sphere-viewer-data.netlify.app/assets/sphere.jpg" }
];

const PRODUCTS = [
  { id: "pizza", name: "Pizza Pepperoni", price: 129, img: "https://images3.memedroid.com/images/UPLOADED247/63bcf7128eb32.jpeg" },
  { id: "combo", name: "Combo FNAF", price: 189, img: "https://images.unsplash.com/photo-1599974579688-8dbdd335c77f?q=80&w=400" },
  { id: "playera", name: "Playera FNAF", price: 249, img: "https://c.tenor.com/yFe8fgyL_RoAAAAC/hombre-morado-bailando.gif" }
];

const viewer = new Viewer({
  container: document.getElementById("viewer"),
  panorama: SCENES[0].url,
  navbar: ["zoom", "fullscreen"]
});

let cart = [];
const fmt = new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN" });

function renderProducts() {
  const el = document.getElementById("products");
  el.innerHTML = "";
  PRODUCTS.forEach(p => {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <img src="${p.img}">
      <div>
        <b>${p.name}</b>
        <div class="price">${fmt.format(p.price)}</div>
      </div>
      <div class="actions">
        <button>Agregar</button>
      </div>
    `;
    d.querySelector("button").onclick = () => {
      cart.push({ id: p.id, qty: 1 });
      renderCart();
    };
    el.appendChild(d);
  });
}

function renderCart() {
  document.getElementById("cartCount").textContent = cart.length;
  const body = document.getElementById("cartBody");
  body.innerHTML = "";

  if (!cart.length) {
    body.innerHTML = '<div class="empty">Vacío</div>';
    return;
  }

  let total = 0;

  cart.forEach(item => {
    const p = PRODUCTS.find(x => x.id === item.id);
    total += p.price;

    body.innerHTML += `
      <div class="cart-row">
        <img src="${p.img}">
        <div>${p.name}</div>
        <div>${fmt.format(p.price)}</div>
      </div>
    `;
  });

  document.getElementById("totals").innerHTML =
    `<div class="line"><b>Total</b><b>${fmt.format(total)}</b></div>`;
}

renderProducts();
renderCart();

document.getElementById("checkoutBtn").addEventListener("click", async () => {

  if (!cart.length) {
    alert("Tu carrito está vacío");
    return;
  }

  const email = prompt("Ingresa tu correo para enviarte el ticket:");

  if (!email) {
    alert("Debes ingresar un correo");
    return;
  }

  const items = cart.map(x => {
    const p = PRODUCTS.find(pp => pp.id === x.id);
    return {
      title: p.name,
      quantity: x.qty,
      unit_price: p.price
    };
  });

  try {
    const response = await fetch(`${RENDER_API_URL}/api/create_preference`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        items,
        payer_email: email
      })
    });

    const data = await response.json();

    if (!response.ok) {
      console.error(data);
      alert("Error creando preferencia");
      return;
    }

    const mp = new MercadoPago(MP_PUBLIC_KEY);
    const bricksBuilder = mp.bricks();

    document.getElementById("walletBrick_container").innerHTML = "";

    await bricksBuilder.create("wallet", "walletBrick_container", {
      initialization: {
        preferenceId: data.id
      }
    });

  } catch (error) {
    console.error("Error:", error);
    alert("Error en el proceso");
  }
});

// Paneles
const storePanel = document.getElementById("storePanel");
const cartPanel = document.getElementById("cartPanel");

document.getElementById("openStore").onclick = () => storePanel.classList.add("open");
document.getElementById("openStore2").onclick = () => storePanel.classList.add("open");
document.getElementById("closeStore").onclick = () => storePanel.classList.remove("open");
document.getElementById("openCart").onclick = () => cartPanel.classList.add("open");
document.getElementById("closeCart").onclick = () => cartPanel.classList.remove("open");

</script>
